<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多遊戲平台</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 900px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #555; }
        input[type="text"], input[type="number"], select { padding: 8px; margin: 5px 0 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        #lobby, #game-room-view { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .room-list-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .room-list-item:last-child { border-bottom: none; }
        #log-area { margin-top: 20px; background-color: #e9e9e9; padding: 10px; border-radius: 4px; height: 150px; overflow-y: auto; font-size: 0.9em; }
        .game-state, .player-hand, .actions { margin-bottom: 15px; }
        .player-info { border: 1px solid #eee; padding: 5px; margin-bottom: 5px; border-radius: 3px; }
        .current-turn { font-weight: bold; background-color: #fff3cd; }
        .welcome-message { margin-bottom: 10px; font-style: italic; color: #337ab7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>多遊戲平台</h1>

        <div id="connection-setup">
            <h2>連線設定</h2>
            <label for="playerName">你的名字:</label>
            <input type="text" id="playerName" value=""> <button id="connectButton">連線並進入大廳</button>
            <p>SID: <span id="mySid">尚未連線</span></p>
            <p>狀態: <span id="connectionStatus">未連線</span></p>
        </div>

        <div id="lobby" class="hidden">
            <h2>遊戲大廳</h2>
            <p class="welcome-message">歡迎, <span id="lobbyPlayerName"></span>!</p>
            <div id="create-room-section">
                <h3>創建新房間</h3>
                <label for="gameType">選擇遊戲:</label>
                <select id="gameType">
                    <option value="texas_holdem">德州撲克</option>
                    <option value="black_jack">21點</option>
                </select>
                <div id="texas-holdem-options">
                    <label for="buyIn">初始籌碼:</label>
                    <input type="number" id="buyIn" value="1000">
                    <label for="smallBlind">小盲注:</label>
                    <input type="number" id="smallBlind" value="10">
                    <label for="bigBlind">大盲注:</label>
                    <input type="number" id="bigBlind" value="20">
                </div>
                <div id="black-jack-options" class="hidden">
                    <label for="bjBuyIn">初始籌碼:</label>
                    <input type="number" id="bjBuyIn" value="1000">
                    <label for="minBet">最小下注:</label>
                    <input type="number" id="minBet" value="10">
                    <label for="maxBet">最大下注:</label>
                    <input type="number" id="maxBet" value="500">
                </div>
                <button id="createRoomButton">創建房間</button>
            </div>

            <div id="room-list-section">
                <h3>可加入的房間</h3>
                <div id="roomList">
                    <p>正在獲取房間列表...</p>
                </div>
            </div>
        </div>

        <div id="game-room-view" class="hidden">
            <h2 id="room-title">遊戲房間</h2>
            <p class="welcome-message">你好, <span id="gameRoomPlayerName"></span>!</p>
            <button id="leaveRoomButton">離開房間</button>
            <button id="startGameButton">開始遊戲</button>

            <div class="game-state">
                <h3>遊戲狀態 (<span id="currentGamePhase">---</span>)</h3>
                <p>底池: <span id="pot">0</span></p>
                <div id="texas-holdem-state">
                    <p>公共牌: <span id="communityCards">---</span></p>
                    <p>輪到: <span id="currentPlayerTurn">---</span></p>
                    <p>當前需跟注: <span id="currentBetToMatch">0</span></p>
                    <p>最小加注額(增量): <span id="minRaiseIncrementDisplay">0</span></p>
                </div>
                <div id="black-jack-state" class="hidden">
                    <p>莊家牌: <span id="dealerCards">---</span></p>
                    <p>莊家點數: <span id="dealerPoints">0</span></p>
                </div>
            </div>

            <div class="player-hand">
                <h3>我的手牌</h3>
                <p id="myHandDisplay">---</p>
                <p id="myPointsDisplay" class="hidden">我的點數: 0</p>
            </div>

            <div id="players-display">
                <h3>玩家列表</h3>
            </div>

            <div class="actions">
                <h3>我的操作</h3>
                <div id="game-actions-panel">
                    <input type="number" id="actionAmount" placeholder="金額" value="0">
                    <div id="texas-holdem-actions">
                        <button data-action="fold">棄牌 (Fold)</button>
                        <button data-action="check">過牌 (Check)</button>
                        <button data-action="call">跟注 (Call)</button>
                        <button data-action="bet">下注 (Bet)</button>
                        <button data-action="raise">加注 (Raise)</button>
                    </div>
                    <div id="black-jack-actions" class="hidden">
                        <button data-action="bet">下注 (Bet)</button>
                        <button data-action="hit">要牌 (Hit)</button>
                        <button data-action="stand">停牌 (Stand)</button>
                        <button data-action="double">加倍 (Double)</button>
                        <button data-action="insurance">保險 (Insurance)</button>
                        <button data-action="decline_insurance">拒絕保險</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="log-area-container">
            <h3>訊息日誌</h3>
            <div id="log-area"></div>
        </div>
    </div>

    <script>
        const socket = io('http://' + document.domain + ':' + location.port, {
            autoConnect: false // 初始不自動連接，由按鈕或邏輯觸發
        }); 
        let mySid = null;
        let currentPlayerName = '';
        let currentRoomId = null;
        let currentGameType = null;
        let currentGameStateForClient = {}; 

        // UI 元素
        const connectionSetupDiv = document.getElementById('connection-setup');
        const lobbyDiv = document.getElementById('lobby');
        const gameRoomViewDiv = document.getElementById('game-room-view');
        const connectButton = document.getElementById('connectButton');
        const playerNameInput = document.getElementById('playerName');
        const mySidDisplay = document.getElementById('mySid');
        const connectionStatusDisplay = document.getElementById('connectionStatus');
        const lobbyPlayerNameSpan = document.getElementById('lobbyPlayerName'); 
        const gameRoomPlayerNameSpan = document.getElementById('gameRoomPlayerName'); 
        const createRoomButton = document.getElementById('createRoomButton');
        const gameTypeSelect = document.getElementById('gameType');
        const texasHoldemOptions = document.getElementById('texas-holdem-options');
        const blackJackOptions = document.getElementById('black-jack-options');
        const roomListDiv = document.getElementById('roomList');
        const roomTitleH2 = document.getElementById('room-title');
        const leaveRoomButton = document.getElementById('leaveRoomButton');
        const startGameButton = document.getElementById('startGameButton');
        const currentGamePhaseDisplay = document.getElementById('currentGamePhase');
        const potDisplay = document.getElementById('pot');
        const texasHoldemState = document.getElementById('texas-holdem-state');
        const blackJackState = document.getElementById('black-jack-state');
        const communityCardsDisplay = document.getElementById('communityCards');
        const dealerCardsDisplay = document.getElementById('dealerCards');
        const dealerPointsDisplay = document.getElementById('dealerPoints');
        const currentPlayerTurnDisplay = document.getElementById('currentPlayerTurn');
        const currentBetToMatchDisplay = document.getElementById('currentBetToMatch');
        const minRaiseIncrementDisplay = document.getElementById('minRaiseIncrementDisplay'); 
        const myHandDisplay = document.getElementById('myHandDisplay');
        const myPointsDisplay = document.getElementById('myPointsDisplay');
        const playersDisplayDiv = document.getElementById('players-display');
        const gameActionsPanel = document.getElementById('game-actions-panel');
        const texasHoldemActions = document.getElementById('texas-holdem-actions');
        const blackJackActions = document.getElementById('black-jack-actions');
        const actionAmountInput = document.getElementById('actionAmount');
        const logArea = document.getElementById('log-area');

        // --- localStorage 相關函式 ---
        const PLAYER_NAME_KEY = 'multiGamePlayerName';

        function savePlayerNameToStorage(name) {
            try {
                localStorage.setItem(PLAYER_NAME_KEY, name);
            } catch (e) {
                addToLog('無法儲存玩家名稱到 localStorage。', 'error');
                console.error("Error saving to localStorage:", e);
            }
        }

        function loadPlayerNameFromStorage() {
            try {
                const storedName = localStorage.getItem(PLAYER_NAME_KEY);
                if (storedName && storedName.trim()) {
                    currentPlayerName = storedName.trim();
                    playerNameInput.value = currentPlayerName; // 預填輸入框
                    addToLog(`從 localStorage 載入名稱: ${currentPlayerName}`);
                    return true;
                }
            } catch (e) {
                addToLog('無法從 localStorage 讀取玩家名稱。', 'error');
                console.error("Error loading from localStorage:", e);
            }
            return false;
        }


        // --- 日誌函式 ---
        function addToLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${time}] ${type === 'error' ? 'ERROR: ' : ''}${message}`;
            if (type === 'error') logEntry.style.color = 'red';
            logArea.insertBefore(logEntry, logArea.firstChild); 
            if (logArea.childElementCount > 50) { 
                logArea.removeChild(logArea.lastChild);
            }
        }

        // --- UI 更新函式 ---
        function showView(viewName) {
            connectionSetupDiv.classList.add('hidden');
            lobbyDiv.classList.add('hidden');
            gameRoomViewDiv.classList.add('hidden');

            if (viewName === 'connection') {
                connectionSetupDiv.classList.remove('hidden');
                connectButton.disabled = false; // 確保按鈕可用
                playerNameInput.disabled = false;
            } else if (viewName === 'lobby') {
                lobbyDiv.classList.remove('hidden');
                if(lobbyPlayerNameSpan) lobbyPlayerNameSpan.textContent = currentPlayerName || "訪客";
            } else if (viewName === 'game-room') {
                gameRoomViewDiv.classList.remove('hidden');
                if(gameRoomPlayerNameSpan) gameRoomPlayerNameSpan.textContent = currentPlayerName || "訪客";
            }
        }
        
        function updateRoomList(rooms) {
            roomListDiv.innerHTML = ''; 
            if (!rooms || Object.keys(rooms).length === 0) { // 增加對 rooms 的檢查
                roomListDiv.innerHTML = '<p>目前沒有可加入的房間。</p>';
                return;
            }
            for (const roomId in rooms) {
                const gameType = rooms[roomId]; 
                const roomItem = document.createElement('div');
                roomItem.classList.add('room-list-item');
                roomItem.innerHTML = `
                    <span>房間 ID: ${roomId} (遊戲: ${gameType})</span>
                    <button class="join-room-btn" data-roomid="${roomId}">加入房間</button>
                `;
                roomListDiv.appendChild(roomItem);
            }
            document.querySelectorAll('.join-room-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const roomIdToJoin = event.target.dataset.roomid;
                    if (!currentPlayerName){ // 確保有名字才能加入
                        alert("請先在連線設定中輸入您的名字並點擊 '連線並進入大廳'。");
                        showView('connection');
                        return;
                    }
                    socket.emit('join_room_request', { room_id: roomIdToJoin, player_name: currentPlayerName });
                });
            });
        }
        
        function updateGameView(gameState) {
            if (!gameState) {
                addToLog("收到空的遊戲狀態", "error");
                return;
            }
            currentGameStateForClient = gameState; 

            currentGameType = gameState.game_type;
            currentRoomId = gameState.room_id || currentRoomId; // 更新 currentRoomId
            roomTitleH2.textContent = `遊戲房間: ${currentRoomId} (類型: ${currentGameType})`;
            currentGamePhaseDisplay.textContent = gameState.game_phase || '等待開始';
            potDisplay.textContent = gameState.pot || 0;

            // 顯示正確的遊戲相關UI
            if (currentGameType === 'texas_holdem') {
                texasHoldemState.classList.remove('hidden');
                blackJackState.classList.add('hidden');
                texasHoldemActions.classList.remove('hidden');
                blackJackActions.classList.add('hidden');
                myPointsDisplay.classList.add('hidden');
                
                communityCardsDisplay.textContent = gameState.community_cards && gameState.community_cards.length > 0 ?
                    gameState.community_cards.map(c => `${c.rank}${c.suit}`).join(' ') : '---';
                currentBetToMatchDisplay.textContent = gameState.current_street_bet_to_match || 0; 
                minRaiseIncrementDisplay.textContent = gameState.min_next_raise_increment || 0; 

                const me = gameState.players.find(p => p.sid === mySid); 
                if (me && me.hand && me.hand.length > 0) {
                    myHandDisplay.textContent = me.hand.map(c => `${c.rank}${c.suit}`).join(' ');
                } else {
                    myHandDisplay.textContent = '---';
                }
            } else if (currentGameType === 'black_jack') {
                texasHoldemState.classList.add('hidden');
                blackJackState.classList.remove('hidden');
                texasHoldemActions.classList.add('hidden');
                blackJackActions.classList.remove('hidden');
                myPointsDisplay.classList.remove('hidden');
                
                // 更新莊家牌
                if (gameState.dealer && gameState.dealer.hand) {
                    dealerCardsDisplay.textContent = gameState.dealer.hand.map(c => `${c.rank}${c.suit}`).join(' ');
                    dealerPointsDisplay.textContent = gameState.dealer.hand_value || '?';
                } else {
                    dealerCardsDisplay.textContent = '---';
                    dealerPointsDisplay.textContent = '0';
                }
                
                // 更新自己的牌
                const me = gameState.players.find(p => p.sid === mySid);
                if (me && me.hand && me.hand.length > 0) {
                    myHandDisplay.textContent = me.hand.map(c => `${c.rank}${c.suit}`).join(' ');
                    myPointsDisplay.textContent = `我的點數: ${me.hand_value || 0}`;
                } else {
                    myHandDisplay.textContent = '---';
                    myPointsDisplay.textContent = '我的點數: 0';
                }
                
                // 根據遊戲階段顯示/隱藏按鈕
                const blackJackButtons = blackJackActions.querySelectorAll('button');
                blackJackButtons.forEach(btn => btn.classList.add('hidden'));
                
                const isMyTurn = gameState.current_turn_sid === mySid;
                const canAct = gameState.can_act === true;
                
                if (gameState.game_phase === 'betting' && isMyTurn && !me.has_acted_this_round) {
                    blackJackActions.querySelector('[data-action="bet"]').classList.remove('hidden');
                } else if (gameState.game_phase === 'player_turns' && isMyTurn) {
                    blackJackActions.querySelector('[data-action="hit"]').classList.remove('hidden');
                    blackJackActions.querySelector('[data-action="stand"]').classList.remove('hidden');
                    if (me && me.hand && me.hand.length === 2 && !me.has_doubled_down) {
                        blackJackActions.querySelector('[data-action="double"]').classList.remove('hidden');
                    }
                } else if (gameState.game_phase === 'insurance' && isMyTurn && !me.has_insurance) {
                    blackJackActions.querySelector('[data-action="insurance"]').classList.remove('hidden');
                    blackJackActions.querySelector('[data-action="decline_insurance"]').classList.remove('hidden');
                }
                
                // 禁用按鈕如果不是我的回合
                blackJackButtons.forEach(btn => {
                    if (!btn.classList.contains('hidden')) {
                        btn.disabled = !canAct;
                    }
                });
                actionAmountInput.disabled = !canAct;
            }

            playersDisplayDiv.innerHTML = '<h3>玩家列表</h3>';
            let currentTurnPlayerName = '---';
            if (gameState.players && Array.isArray(gameState.players)) {
                gameState.players.forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.classList.add('player-info');
                    
                    let playerText = `${player.name || '未知玩家'} (籌碼: ${player.chips})`;
                    
                    if (currentGameType === 'texas_holdem') {
                        playerText += `, 本街道下注: ${player.bet_in_current_street || 0}`;
                        if (!player.is_active_in_round && gameState.is_game_in_progress) playerText += " (已棄牌/旁觀)";
                        if (player.is_all_in) playerText += " (All-in)";
                    } else if (currentGameType === 'black_jack') {
                        playerText += `, 下注: ${player.bet || 0}`;
                        if (player.is_busted) playerText += " (爆牌)";
                        if (player.has_blackjack) playerText += " (21點)";
                        if (player.has_doubled_down) playerText += " (已加倍)";
                        if (player.has_insurance) playerText += " (已投保)";
                        if (player.has_acted_this_round) playerText += " (已行動)";
                    }

                    if (player.sid === gameState.current_turn_sid) { 
                        playerDiv.classList.add('current-turn');
                        currentTurnPlayerName = player.name || '未知玩家';
                    }
                    playerDiv.textContent = playerText;
                    playersDisplayDiv.appendChild(playerDiv);
                });
            }
            currentPlayerTurnDisplay.textContent = currentTurnPlayerName;

            const gameIsActuallyInProgress = gameState.is_game_in_progress === true;
            startGameButton.disabled = gameIsActuallyInProgress; 

            if (gameState.message) { 
                addToLog(`遊戲訊息: ${gameState.message}`);
            }
        }


        // --- Socket.IO 事件監聽 ---
        socket.on('connect', () => {
            mySid = socket.id;
            mySidDisplay.textContent = mySid;
            connectionStatusDisplay.textContent = '已連線!';
            addToLog('成功連接到伺服器。');

            // 只有在 currentPlayerName 已被設定 (來自 localStorage 或 connectButton 點擊) 時才自動進入大廳
            if (currentPlayerName && currentPlayerName.trim()) {
                connectButton.textContent = '已連線';
                connectButton.disabled = true;
                playerNameInput.disabled = true;
                if(lobbyPlayerNameSpan) lobbyPlayerNameSpan.textContent = currentPlayerName;
                if(gameRoomPlayerNameSpan) gameRoomPlayerNameSpan.textContent = currentPlayerName;
                showView('lobby');
                socket.emit('get_lobby_info');
            } else {
                // 如果沒有 currentPlayerName (例如首次訪問或 localStorage 為空)，則停留在連線設定介面
                showView('connection');
                connectButton.disabled = false;
                playerNameInput.disabled = false;
                addToLog('請設定您的名稱並點擊連接按鈕。');
            }
        });

        socket.on('disconnect', () => {
            mySidDisplay.textContent = '尚未連線';
            connectionStatusDisplay.textContent = '已斷線!';
            connectButton.textContent = '連線並進入大廳';
            connectButton.disabled = false;
            playerNameInput.disabled = false; // 允許重新輸入
            showView('connection');
            addToLog('與伺服器斷線。', 'error');
            currentRoomId = null;
            currentGameType = null;
        });

        socket.on('message', (data) => {
            addToLog(`伺服器訊息: ${data.text || JSON.stringify(data)}`);
        });
        socket.on('error_message', (data) => {
            addToLog(`錯誤: ${data.message}`, 'error');
            alert(`錯誤: ${data.message}`);
        });
        socket.on('lobby_update', (data) => {
            console.log('Received lobby_update event. Data:', data);
            if (data && data.rooms) {
                updateRoomList(data.rooms);
                addToLog('大廳房間列表已更新。');
            } else {
                console.error('Received lobby_update but data or data.rooms is invalid:', data);
                addToLog('未能正確更新房間列表，收到的數據有問題。', 'error');
                updateRoomList({});
            }
        });
        socket.on('room_created', (data) => {
            currentRoomId = data.room_id;
            currentGameType = data.game_type;
            addToLog(`房間 ${currentRoomId} (${currentGameType}) 創建成功!`);
            if(gameRoomPlayerNameSpan) gameRoomPlayerNameSpan.textContent = currentPlayerName || "訪客";
            showView('game-room');
        });
        socket.on('joined_room_success', (data) => {
            currentRoomId = data.room_id;
            currentGameType = data.game_type;
            addToLog(`成功加入房間 ${currentRoomId} (${currentGameType})`);
            if(gameRoomPlayerNameSpan) gameRoomPlayerNameSpan.textContent = currentPlayerName || "訪客";
            showView('game-room');
        });
        socket.on('left_room_success', (data) => {
            addToLog(`已離開房間 ${data.room_id}`);
            currentRoomId = null;
            currentGameType = null;
            if(lobbyPlayerNameSpan) lobbyPlayerNameSpan.textContent = currentPlayerName || "訪客";
            showView('lobby');
            myHandDisplay.textContent = '---';
            communityCardsDisplay.textContent = '---';
            dealerCardsDisplay.textContent = '---';
            playersDisplayDiv.innerHTML = '<h3>玩家列表</h3>';
        });
        socket.on('texas_holdem_update', (gameState) => {
            if (currentRoomId === gameState.room_id || (currentRoomId === null && gameState.room_id)) { 
                if (currentRoomId === null) currentRoomId = gameState.room_id; 
                addToLog('收到德州撲克遊戲狀態更新。階段: ' + gameState.game_phase + ', 輪到: ' + gameState.current_turn_sid);
                updateGameView(gameState);
            }
        });
        socket.on('black_jack_update', (gameState) => {
            if (currentRoomId === gameState.room_id || (currentRoomId === null && gameState.room_id)) { 
                if (currentRoomId === null) currentRoomId = gameState.room_id; 
                addToLog('收到21點遊戲狀態更新。階段: ' + gameState.game_phase + ', 輪到: ' + gameState.current_turn_sid);
                updateGameView(gameState);
            }
        });
        socket.on('texas_holdem_error', (data) => { 
            addToLog(`德州撲克錯誤: ${data.message}`, 'error');
            alert(`遊戲錯誤: ${data.message}`);
        });
        socket.on('black_jack_error', (data) => { 
            addToLog(`21點錯誤: ${data.message}`, 'error');
            alert(`遊戲錯誤: ${data.message}`);
        });
        socket.on('texas_holdem_game_over', (data) => { 
            if (currentGameType !== 'texas_holdem') return;
            
            addToLog('德州撲克遊戲結束');
            gameActionsPanel.querySelectorAll('button').forEach(btn => btn.disabled = true);
            actionAmountInput.disabled = true;
            startGameButton.disabled = false; 
            currentPlayerTurnDisplay.textContent = '遊戲結束';
            
            updateGameView(data); 

            let resultText = "遊戲結束!\n";
            if (data && data.winners && data.winners.length > 0) {
                data.winners.forEach(winner => {
                    let handString = 'N/A';
                    if (winner.best_5_card_hand && winner.best_5_card_hand.length > 0) {
                        handString = winner.best_5_card_hand.map(c => `${c.rank}${c.suit}`).join(' ');
                    } else if (winner.hole_cards && winner.hole_cards.length > 0) { 
                        handString = winner.hole_cards.map(c => `${c.rank}${c.suit}`).join(' ');
                    }
                    resultText += `贏家: ${winner.name}, 贏得: ${winner.amount_won}. 牌型: ${winner.best_hand_description || ''}. (${handString}). 原因: ${winner.reason || ''}\n`;
                });
            } else if (data && data.message) { 
                resultText += data.message;
            } else if (data && data.game_over_results && data.game_over_results.message) {
                 resultText += data.game_over_results.message;
            }
            else {
                resultText += "無明確贏家或結果信息。";
            }
            alert(resultText);
        });
        
        socket.on('black_jack_game_over', (data) => { 
            if (currentGameType !== 'black_jack') return;
            
            addToLog('21點遊戲結束');
            gameActionsPanel.querySelectorAll('button').forEach(btn => btn.disabled = true);
            actionAmountInput.disabled = true;
            startGameButton.disabled = false; 
            
            updateGameView(data); 

            let resultText = "遊戲結束!\n\n";
            
            // 添加莊家資訊
            if (data.dealer) {
                const dealerStatus = data.dealer.is_busted ? "爆牌" : 
                                    data.dealer.has_blackjack ? "21點" : 
                                    `點數: ${data.dealer.hand_value}`;
                resultText += `莊家: ${dealerStatus}\n`;
                resultText += `莊家手牌: ${data.dealer.hand.map(c => `${c.rank}${c.suit}`).join(' ')}\n\n`;
            }
            
            // 添加所有玩家的結果
            if (data.results) {
                resultText += "玩家結果:\n";
                data.players.forEach(player => {
                    const result = data.results[player.sid];
                    if (!result) return;
                    
                    // 確定結果文字
                    let outcomeText = "";
                    switch(result.outcome) {
                        case 'blackjack': outcomeText = "21點獲勝"; break;
                        case 'win_dealer_busted': outcomeText = "莊家爆牌，玩家獲勝"; break;
                        case 'win_higher': outcomeText = "點數較高，玩家獲勝"; break;
                        case 'push': outcomeText = "平局"; break;
                        case 'bust': outcomeText = "爆牌，玩家輸"; break;
                        case 'lose_to_blackjack': outcomeText = "莊家21點，玩家輸"; break;
                        case 'lose_lower': outcomeText = "點數較低，玩家輸"; break;
                        default: outcomeText = result.outcome;
                    }
                    
                    // 籌碼變化
                    const payoutText = result.payout > 0 ? `贏得 ${result.payout}` : 
                                    result.payout < 0 ? `損失 ${Math.abs(result.payout)}` : 
                                    "籌碼不變";
                    
                    resultText += `${player.name}: ${outcomeText}, ${payoutText}\n`;
                    resultText += `手牌: ${player.hand.map(c => `${c.rank}${c.suit}`).join(' ')} (點數: ${player.hand_value})\n`;
                    
                    // 如果有保險，添加保險結果
                    if (result.insurance_outcome) {
                        const insText = result.insurance_outcome === 'win' ? 
                                      `保險贏得 ${result.insurance_payout}` : 
                                      `保險損失 ${Math.abs(result.insurance_payout)}`;
                        resultText += `${insText}\n`;
                    }
                    
                    resultText += `目前籌碼: ${player.chips}\n\n`;
                });
            } else if (data && data.message) { 
                resultText += data.message;
            } else {
                resultText += "無明確結果信息。";
            }
            
            // 使用對話框顯示結果
            alert(resultText);
        });

        // --- 按鈕事件綁定 ---
        connectButton.addEventListener('click', () => {
            const nameEntered = playerNameInput.value.trim();
            if (!nameEntered) {
                alert('請輸入你的名字!');
                return;
            }
            currentPlayerName = nameEntered;
            savePlayerNameToStorage(currentPlayerName); // 儲存名稱

            if(lobbyPlayerNameSpan) lobbyPlayerNameSpan.textContent = currentPlayerName;
            if(gameRoomPlayerNameSpan) gameRoomPlayerNameSpan.textContent = currentPlayerName;

            if (!socket.connected) {
                addToLog('嘗試連接到伺服器...');
                socket.connect(); // 觸發 'connect' 事件
            } else {
                // 如果已連接 (例如，之前斷線後手動點擊)，但 currentPlayerName 可能剛設定
                connectButton.textContent = '已連線';
                connectButton.disabled = true;
                playerNameInput.disabled = true;
                showView('lobby');
                socket.emit('get_lobby_info');
            }
        });

        createRoomButton.addEventListener('click', () => {
            const gameType = gameTypeSelect.value;
            let options = {};
            if (gameType === 'texas_holdem') {
                options = {
                    buy_in: parseInt(document.getElementById('buyIn').value) || 1000,
                    small_blind: parseInt(document.getElementById('smallBlind').value) || 10,
                    big_blind: parseInt(document.getElementById('bigBlind').value) || 20,
                };
            } else if (gameType === 'black_jack') {
                options = {
                    buy_in: parseInt(document.getElementById('bjBuyIn').value) || 1000,
                    min_bet: parseInt(document.getElementById('minBet').value) || 10,
                    max_bet: parseInt(document.getElementById('maxBet').value) || 500,
                };
            }
            socket.emit('create_room', {
                game_type: gameType,
                player_name: currentPlayerName,
                options: options
            });
        });
        
        leaveRoomButton.addEventListener('click', () => {
            if (currentRoomId) {
                socket.emit('leave_room_request', { room_id: currentRoomId });
            }
        });
        
        startGameButton.addEventListener('click', () => {
            if (currentRoomId) {
                socket.emit('start_game_request', { room_id: currentRoomId });
                startGameButton.disabled = true; 
            }
        });
        
        gameActionsPanel.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON' && event.target.dataset.action) {
                const action = event.target.dataset.action;
                let payload = {};
                
                if (['bet', 'raise'].includes(action)) { 
                    const amount = parseInt(actionAmountInput.value);
                    if (isNaN(amount) || amount <= 0) { 
                        alert('請輸入有效的金額!');
                        return;
                    }
                    payload.amount = amount;
                }
                
                // 21點特殊動作
                if (action === 'insurance') {
                    const amount = parseInt(actionAmountInput.value);
                    if (isNaN(amount) || amount <= 0) { 
                        alert('請輸入有效的保險金額!');
                        return;
                    }
                    payload.amount = amount;
                }
                
                addToLog(`發送操作: ${action} ${payload.amount !== undefined ? '金額: ' + payload.amount : ''}`);
                socket.emit('game_action', {
                    room_id: currentRoomId,
                    action_type: action,
                    payload: payload
                });
            }
        });

        // --- 初始化 ---
        window.addEventListener('DOMContentLoaded', (event) => {
            loadPlayerNameFromStorage(); // 嘗試載入已儲存的名稱
            showView('connection'); // 預設顯示連線介面

            if (currentPlayerName && currentPlayerName.trim()) {
                addToLog(`偵測到已儲存名稱: ${currentPlayerName}。嘗試自動連接...`);
                socket.connect(); // 如果有名字，嘗試自動連接
            } else {
                addToLog("未找到已儲存的玩家名稱，請手動設定並連接。");
            }
            
            // 切換遊戲選項顯示
            gameTypeSelect.addEventListener('change', function() {
                if (this.value === 'texas_holdem') {
                    texasHoldemOptions.classList.remove('hidden');
                    blackJackOptions.classList.add('hidden');
                } else if (this.value === 'black_jack') {
                    texasHoldemOptions.classList.add('hidden');
                    blackJackOptions.classList.remove('hidden');
                }
            });
        });

    </script>
</body>
</html>

