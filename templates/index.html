<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多遊戲平台</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 900px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #555; }
        input[type="text"], input[type="number"], select { padding: 8px; margin: 5px 0 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        #lobby, #game-room-view { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .room-list-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .room-list-item:last-child { border-bottom: none; }
        #log-area { margin-top: 20px; background-color: #e9e9e9; padding: 10px; border-radius: 4px; height: 150px; overflow-y: auto; font-size: 0.9em; }
        .game-state, .player-hand, .actions { margin-bottom: 15px; }
        .player-info { border: 1px solid #eee; padding: 5px; margin-bottom: 5px; border-radius: 3px; }
        .current-turn { font-weight: bold; background-color: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>多遊戲平台</h1>

        <div id="connection-setup">
            <h2>連線設定</h2>
            <label for="playerName">你的名字:</label>
            <input type="text" id="playerName" value="玩家_XYZ">
            <button id="connectButton">連線並進入大廳</button>
            <p>SID: <span id="mySid">尚未連線</span></p>
            <p>狀態: <span id="connectionStatus">未連線</span></p>
        </div>

        <div id="lobby" class="hidden">
            <h2>遊戲大廳</h2>
            <div id="create-room-section">
                <h3>創建新房間</h3>
                <label for="gameType">選擇遊戲:</label>
                <select id="gameType">
                    <option value="texas_holdem">德州撲克</option>
                    </select>
                <div id="texas-holdem-options">
                    <label for="buyIn">初始籌碼:</label>
                    <input type="number" id="buyIn" value="1000">
                    <label for="smallBlind">小盲注:</label>
                    <input type="number" id="smallBlind" value="10">
                    <label for="bigBlind">大盲注:</label>
                    <input type="number" id="bigBlind" value="20">
                </div>
                <button id="createRoomButton">創建房間</button>
            </div>

            <div id="room-list-section">
                <h3>可加入的房間</h3>
                <div id="roomList">
                    <p>正在獲取房間列表...</p>
                </div>
            </div>
        </div>

        <div id="game-room-view" class="hidden">
            <h2 id="room-title">遊戲房間</h2>
            <button id="leaveRoomButton">離開房間</button>
            <button id="startGameButton">開始遊戲</button>

            <div class="game-state">
                <h3>遊戲狀態 (<span id="currentGamePhase">---</span>)</h3>
                <p>底池: <span id="pot">0</span></p>
                <p>公共牌: <span id="communityCards">---</span></p>
                <p>輪到: <span id="currentPlayerTurn">---</span></p>
                <p>當前需跟注: <span id="currentBetToMatch">0</span></p>
                <p>最小加注額(增量): <span id="minRaiseIncrementDisplay">0</span></p> </div>

            <div class="player-hand">
                <h3>我的手牌</h3>
                <p id="myHandDisplay">---</p>
            </div>

            <div id="players-display">
                <h3>玩家列表</h3>
                </div>

            <div class="actions">
                <h3>我的操作</h3>
                <div id="game-actions-panel">
                    <input type="number" id="actionAmount" placeholder="金額" value="0">
                    <button data-action="fold">棄牌 (Fold)</button>
                    <button data-action="check">過牌 (Check)</button>
                    <button data-action="call">跟注 (Call)</button>
                    <button data-action="bet">下注 (Bet)</button>
                    <button data-action="raise">加注 (Raise)</button>
                </div>
            </div>
        </div>

        <div id="log-area-container">
            <h3>訊息日誌</h3>
            <div id="log-area"></div>
        </div>
    </div>

    <script>
        const socket = io('http://' + document.domain + ':' + location.port); 
        let mySid = null;
        let currentPlayerName = '';
        let currentRoomId = null;
        let currentGameType = null;
        let currentGameStateForClient = {}; // 保存一份最新的遊戲狀態

        const connectionSetupDiv = document.getElementById('connection-setup');
        const lobbyDiv = document.getElementById('lobby');
        const gameRoomViewDiv = document.getElementById('game-room-view');
        const connectButton = document.getElementById('connectButton');
        const playerNameInput = document.getElementById('playerName');
        const mySidDisplay = document.getElementById('mySid');
        const connectionStatusDisplay = document.getElementById('connectionStatus');
        const createRoomButton = document.getElementById('createRoomButton');
        const gameTypeSelect = document.getElementById('gameType');
        const roomListDiv = document.getElementById('roomList');
        const roomTitleH2 = document.getElementById('room-title');
        const leaveRoomButton = document.getElementById('leaveRoomButton');
        const startGameButton = document.getElementById('startGameButton');
        const currentGamePhaseDisplay = document.getElementById('currentGamePhase');
        const potDisplay = document.getElementById('pot');
        const communityCardsDisplay = document.getElementById('communityCards');
        const currentPlayerTurnDisplay = document.getElementById('currentPlayerTurn');
        const currentBetToMatchDisplay = document.getElementById('currentBetToMatch');
        const minRaiseIncrementDisplay = document.getElementById('minRaiseIncrementDisplay'); // 改為 min_next_raise_increment
        const myHandDisplay = document.getElementById('myHandDisplay');
        const playersDisplayDiv = document.getElementById('players-display');
        const gameActionsPanel = document.getElementById('game-actions-panel');
        const actionAmountInput = document.getElementById('actionAmount');
        const logArea = document.getElementById('log-area');

        function addToLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${time}] ${type === 'error' ? 'ERROR: ' : ''}${message}`;
            if (type === 'error') logEntry.style.color = 'red';
            logArea.insertBefore(logEntry, logArea.firstChild); 
            if (logArea.childElementCount > 50) { 
                logArea.removeChild(logArea.lastChild);
            }
        }

        function showView(viewName) {
            connectionSetupDiv.classList.add('hidden');
            lobbyDiv.classList.add('hidden');
            gameRoomViewDiv.classList.add('hidden');
            if (viewName === 'connection') connectionSetupDiv.classList.remove('hidden');
            else if (viewName === 'lobby') lobbyDiv.classList.remove('hidden');
            else if (viewName === 'game-room') gameRoomViewDiv.classList.remove('hidden');
        }

        function updateRoomList(rooms) {
            roomListDiv.innerHTML = ''; 
            if (Object.keys(rooms).length === 0) {
                roomListDiv.innerHTML = '<p>目前沒有可加入的房間。</p>';
                return;
            }
            for (const roomId in rooms) {
                const gameType = rooms[roomId]; 
                const roomItem = document.createElement('div');
                roomItem.classList.add('room-list-item');
                roomItem.innerHTML = `
                    <span>房間 ID: ${roomId} (遊戲: ${gameType})</span>
                    <button class="join-room-btn" data-roomid="${roomId}">加入房間</button>
                `;
                roomListDiv.appendChild(roomItem);
            }
            document.querySelectorAll('.join-room-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const roomIdToJoin = event.target.dataset.roomid;
                    socket.emit('join_room_request', { room_id: roomIdToJoin, player_name: currentPlayerName });
                });
            });
        }

        function updateGameView(gameState) {
            if (!gameState) {
                addToLog("收到空的遊戲狀態", "error");
                return;
            }
            currentGameStateForClient = gameState; // 保存最新狀態

            currentGameType = gameState.game_type;
            roomTitleH2.textContent = `遊戲房間: ${currentRoomId || gameState.room_id} (類型: ${currentGameType})`;
            currentGamePhaseDisplay.textContent = gameState.game_phase || '等待開始';
            potDisplay.textContent = gameState.pot || 0;

            if (gameState.game_type === 'texas_holdem') {
                communityCardsDisplay.textContent = gameState.community_cards && gameState.community_cards.length > 0 ?
                    gameState.community_cards.map(c => `${c.rank}${c.suit}`).join(' ') : '---';
                currentBetToMatchDisplay.textContent = gameState.current_street_bet_to_match || 0; // 後端應為 current_street_bet_to_match
                minRaiseIncrementDisplay.textContent = gameState.min_next_raise_increment || 0; // 後端應為 min_next_raise_increment

                const me = gameState.players.find(p => p.sid === mySid); 
                if (me && me.hand && me.hand.length > 0) {
                    myHandDisplay.textContent = me.hand.map(c => `${c.rank}${c.suit}`).join(' ');
                } else {
                    myHandDisplay.textContent = '---';
                }
            } else {
                communityCardsDisplay.textContent = 'N/A';
                myHandDisplay.textContent = 'N/A';
            }

            playersDisplayDiv.innerHTML = '<h3>玩家列表</h3>';
            let currentTurnPlayerName = '---';
            if (gameState.players && Array.isArray(gameState.players)) {
                gameState.players.forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.classList.add('player-info');
                    let playerText = `${player.name || '未知玩家'} (籌碼: ${player.chips}, 本街道下注: ${player.bet_in_current_street || 0})`;
                    if (!player.is_active_in_round && gameState.is_game_in_progress) playerText += " (已棄牌/旁觀)";
                    if (player.is_all_in) playerText += " (All-in)";

                    if (player.sid === gameState.current_turn_sid) { 
                        playerDiv.classList.add('current-turn');
                        currentTurnPlayerName = player.name || '未知玩家';
                    }
                    playerDiv.textContent = playerText;
                    playersDisplayDiv.appendChild(playerDiv);
                });
            }
            currentPlayerTurnDisplay.textContent = currentTurnPlayerName;

            const myTurn = gameState.current_turn_sid === mySid && gameState.is_game_in_progress === true;
            gameActionsPanel.querySelectorAll('button').forEach(btn => btn.disabled = !myTurn);
            actionAmountInput.disabled = !myTurn;
            startGameButton.disabled = gameState.is_game_in_progress === true;

            if (gameState.message) { 
                addToLog(`遊戲訊息: ${gameState.message}`);
            }
        }

        socket.on('connect', () => {
            mySid = socket.id;
            mySidDisplay.textContent = mySid;
            connectionStatusDisplay.textContent = '已連線!';
            connectButton.textContent = '已連線';
            connectButton.disabled = true;
            playerNameInput.disabled = true;
            showView('lobby');
            addToLog('成功連接到伺服器。');
            socket.emit('get_lobby_info'); 
        });

        socket.on('disconnect', () => {
            mySidDisplay.textContent = '尚未連線';
            connectionStatusDisplay.textContent = '已斷線!';
            connectButton.textContent = '連線並進入大廳';
            connectButton.disabled = false;
            playerNameInput.disabled = false;
            showView('connection');
            addToLog('與伺服器斷線。', 'error');
            currentRoomId = null;
            currentGameType = null;
        });

        socket.on('message', (data) => {
            addToLog(`伺服器訊息: ${data.text || JSON.stringify(data)}`);
        });

        socket.on('error_message', (data) => {
            addToLog(`錯誤: ${data.message}`, 'error');
            alert(`錯誤: ${data.message}`);
        });

        socket.on('lobby_update', (data) => {
            console.log('Received lobby_update event. Data:', data);
            if (data && data.rooms) {
                updateRoomList(data.rooms);
                addToLog('大廳房間列表已更新。');
            } else {
                console.error('Received lobby_update but data or data.rooms is invalid:', data);
                addToLog('未能正確更新房間列表，收到的數據有問題。', 'error');
                updateRoomList({});
            }
        });

        socket.on('room_created', (data) => {
            currentRoomId = data.room_id;
            currentGameType = data.game_type;
            addToLog(`房間 ${currentRoomId} (${currentGameType}) 創建成功!`);
            showView('game-room');
        });

        socket.on('joined_room_success', (data) => {
            currentRoomId = data.room_id;
            currentGameType = data.game_type;
            addToLog(`成功加入房間 ${currentRoomId} (${currentGameType})`);
            showView('game-room');
        });

        socket.on('left_room_success', (data) => {
            addToLog(`已離開房間 ${data.room_id}`);
            currentRoomId = null;
            currentGameType = null;
            showView('lobby');
            myHandDisplay.textContent = '---';
            communityCardsDisplay.textContent = '---';
            playersDisplayDiv.innerHTML = '<h3>玩家列表</h3>';
        });

        socket.on('texas_holdem_update', (gameState) => {
            if (currentRoomId === gameState.room_id) {
                addToLog('收到德州撲克遊戲狀態更新。階段: ' + gameState.game_phase + ', 輪到: ' + gameState.current_turn_sid);
                updateGameView(gameState);
            }
        });
        socket.on('texas_holdem_error', (data) => { 
            addToLog(`德州撲克錯誤: ${data.message}`, 'error');
            alert(`遊戲錯誤: ${data.message}`);
        });

        socket.on('texas_holdem_game_over', (data) => { 
            addToLog('德州撲克遊戲結束 EVENT RECEIVED. Data: ' + JSON.stringify(data));

            // --- 立即禁用操作按鈕 ---
            gameActionsPanel.querySelectorAll('button').forEach(btn => btn.disabled = true);
            actionAmountInput.disabled = true;
            startGameButton.disabled = false; // 允許開始新遊戲
            currentPlayerTurnDisplay.textContent = '遊戲結束';
            // --- 結束立即禁用 ---
            
            // 使用收到的 data (應包含 is_game_in_progress: false) 來更新視圖
            // data 本身應該就是一個完整的 gameState 結構，或者包含一個 final_state
            updateGameView(data); // data 應包含 is_game_in_progress: false

            let resultText = "遊戲結束!\n";
            const gameOverResults = data.game_over_results; // 後端 end_game 應發送此結構

            if (gameOverResults && gameOverResults.winners && gameOverResults.winners.length > 0) {
                gameOverResults.winners.forEach(winner => {
                    let handString = 'N/A';
                    // 'hand' 是玩家的底牌, 'best_5_card_hand' 是組成最佳牌型的牌
                    if (winner.best_5_card_hand && winner.best_5_card_hand.length > 0) {
                        handString = winner.best_5_card_hand.map(c => `${c.rank}${c.suit}`).join(' ');
                    } else if (winner.hand && winner.hand.length > 0) { // 備用顯示底牌
                        handString = winner.hand.map(c => `${c.rank}${c.suit}`).join(' ');
                    }
                    resultText += `贏家: ${winner.name}, 贏得: ${winner.amount_won}. 牌型: ${winner.best_hand_description || ''}. (${handString}). 原因: ${winner.reason || ''}\n`;
                });
            } else if (gameOverResults && gameOverResults.message) {
                resultText += gameOverResults.message;
            } else {
                resultText += "無明確贏家或結果信息。";
            }
            alert(resultText);
        });

        connectButton.addEventListener('click', () => {
            currentPlayerName = playerNameInput.value.trim();
            if (!currentPlayerName) {
                alert('請輸入你的名字!');
                return;
            }
            if (!socket.connected) {
                socket.connect(); 
                addToLog('嘗試連接到伺服器...');
            } else {
                showView('lobby');
            }
        });

        createRoomButton.addEventListener('click', () => {
            const gameType = gameTypeSelect.value;
            let options = {};
            if (gameType === 'texas_holdem') {
                options = {
                    buy_in: parseInt(document.getElementById('buyIn').value) || 1000,
                    small_blind: parseInt(document.getElementById('smallBlind').value) || 10,
                    big_blind: parseInt(document.getElementById('bigBlind').value) || 20,
                };
            }
            socket.emit('create_room', {
                game_type: gameType,
                player_name: currentPlayerName,
                options: options
            });
        });

        leaveRoomButton.addEventListener('click', () => {
            if (currentRoomId) {
                socket.emit('leave_room_request', { room_id: currentRoomId });
            }
        });

        startGameButton.addEventListener('click', () => {
            if (currentRoomId) {
                socket.emit('start_game_request', { room_id: currentRoomId });
                startGameButton.disabled = true; 
            }
        });

        gameActionsPanel.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON' && event.target.dataset.action) {
                const action = event.target.dataset.action;
                let payload = {};
                if (['bet', 'raise'].includes(action)) { 
                    const amount = parseInt(actionAmountInput.value);
                    if (isNaN(amount) || (action === 'bet' && amount <=0) || (action === 'raise' && amount <=0) ) { // Raise 的 amount 是總額
                        alert('請輸入有效的金額!');
                        return;
                    }
                    payload.amount = amount;
                }
                // Call 通常不需要前端傳 amount，後端會根據 current_street_bet_to_match 計算
                // Fold 和 Check 不需要 payload.amount
                
                addToLog(`發送操作: ${action} ${payload.amount !== undefined ? '金額: ' + payload.amount : ''}`);
                socket.emit('game_action', {
                    room_id: currentRoomId,
                    action_type: action,
                    payload: payload
                });
            }
        });

        showView('connection'); 
        document.getElementById('texas-holdem-options').style.display = 'block'; 
        gameTypeSelect.addEventListener('change', function() {
            document.getElementById('texas-holdem-options').style.display = this.value === 'texas_holdem' ? 'block' : 'none';
        });

    </script>
</body>
</html>
